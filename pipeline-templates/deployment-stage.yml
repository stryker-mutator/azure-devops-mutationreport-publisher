parameters: 
    name: ''
    environment: ''
    vsixFilePattern: ''
    isTestPackage: 'True'
    condition: 'Succeeded()'

variables:
- name: 'marketplaceServiceConnection'
  value: '5cd0e51c-cdd4-4d82-97d7-40368eaeb5aa' 

stages:
- stage: Deploy_${{ parameters.name }}
  displayName: Deploy ${{ parameters.name }}
  condition: ${{ parameters.condition }}
  jobs:
  - deployment: PublishToMarketplace_${{ parameters.name }}
    displayName: Publish (${{ parameters.name }})
    pool:
      vmImage: 'ubuntu-latest'
    environment: ${{ parameters.environment }}
    strategy:
      runOnce:
        deploy:
          steps:
          - task: AzureCLI@2
            inputs:
              azureSubscription: 'get visual studio marketplace stryker-mutator token'
              scriptType: 'pscore'
              scriptLocation: 'inlineScript'
              useGlobalConfig: true
              inlineScript: |
                $accessToken = az account get-access-token --resource 499b84ac-1321-427f-aa17-267ca6975798 --query "accessToken" --output tsv
                write-host "##vso[task.setsecret]$accessToken"
                write-host "##vso[task.setendpoint id=$env:MARKETPLACESERVICECONNECTION;field=authParameter;key=password]$accessToken"
          - task: TfxInstaller@4
            inputs:
              checkLatest: true
          - task: PublishAzureDevOpsExtension@4
            inputs:
              connectTo: 'VsTeam'
              connectedServiceName: '$(marketplaceServiceConnection)'
              fileType: 'vsix'
              vsixFile: $(Pipeline.Workspace)/${{ parameters.vsixFilePattern }}
              updateTasksId: ${{ parameters.isTestPackage }}
              updateTasksVersion: false
          - task: IsAzureDevOpsExtensionValid@4
            inputs:
              connectTo: 'VsTeam'
              connectedServiceName: '$(marketplaceServiceConnection)'
              method: 'vsix'
              vsixFile: $(Pipeline.Workspace)/${{ parameters.vsixFilePattern }}
