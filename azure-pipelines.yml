variables:
  buildNumber: $[counter(variables['packageVersion'], 1)]
  packageVersion: '0.1.0'
  packageVersionDev: $(packageVersion).$(buildNumber)

trigger:
- master

stages:
- stage: BuildandTest
  displayName: 'Build test and package extension'
  jobs:
  - job: Build
    pool: 
      vmImage: 'ubuntu-latest'

    steps:
    - script: echo "##vso[build.updatebuildnumber]$(packageVersionDev)"
      displayName: 'Set build number'

    - task: replacetokens@3
      inputs:
        targetFiles: |
          '**/vss-extension.json'
          '**/vss-extension-patch.dev.json'

    - task: NodeTool@0
      inputs:
        versionSpec: '12.x'
      displayName: 'Install Node.js LTS'

    - script: |
        npm install
        npx lerna bootstrap
        npx lerna run compile
      displayName: 'Build'

    - script: ''
      displayName: 'Test'

    - script: |
        npm run package -- --output-path $(Build.ArtifactStagingDirectory)/prod
      displayName: 'create production extension'
    - script: |
        npm run package:dev -- --output-path $(Build.ArtifactStagingDirectory)/dev
      displayName: 'create development extension'

    - task: PublishPipelineArtifact@1
      inputs:
        targetPath: '$(Build.ArtifactStagingDirectory)'
        artifact: 'mutation-report-publisher'

- template: 'pipeline-templates/deployment-stage.yml'
  parameters: 
    name: 'dev'
    environment: 'Visual studio marketplace development'
    vsixFilePattern: '$(Build.ArtifactStagingDirectory)/dev/*.vsix'
    requireMaster: 'false'
- template: 'pipeline-templates/deployment-stage.yml'
  parameters: 
    name: 'prod'
    environment: 'Visual studio marketplace production'
    vsixFilePattern: '$(Build.ArtifactStagingDirectory)/prod/*.vsix'
    requireMaster: 'true'